name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: ''
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: |
          npm install -g bun
          bun install

      - name: Install sharp for icon generation
        run: bun add -d sharp

      - name: Generate icons
        run: |
          mkdir -p src-tauri/icons
          bun -e "
          const sharp = require('sharp');
          const fs = require('fs');
          const path = require('path');

          const svg = '<svg width=\"1024\" height=\"1024\" xmlns=\"http://www.w3.org/2000/svg\"><defs><linearGradient id=\"grad\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\"><stop offset=\"0%\" style=\"stop-color:#667eea;stop-opacity:1\" /><stop offset=\"100%\" style=\"stop-color:#764ba2;stop-opacity:1\" /></linearGradient></defs><rect width=\"100%\" height=\"100%\" fill=\"url(#grad)\" rx=\"128\"/><text x=\"50%\" y=\"58%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"white\" font-size=\"500\" font-family=\"Arial\" font-weight=\"bold\">M</text></svg>';

          (async () => {
            const iconsDir = 'src-tauri/icons';
            
            const sizes = [[1024, 'icon.png'], [32, '32x32.png'], [128, '128x128.png'], [256, '128x128@2x.png']];

            for (const [size, name] of sizes) {
              await sharp(Buffer.from(svg)).resize(size, size).png().toFile(path.join(iconsDir, name));
              console.log('Created ' + name);
            }

            const ico256 = await sharp(Buffer.from(svg)).resize(256, 256).png().toBuffer();
            
            const pngData = ico256;
            const icoHeader = Buffer.alloc(6);
            icoHeader.writeUInt16LE(0, 0);
            icoHeader.writeUInt16LE(1, 2);
            icoHeader.writeUInt16LE(1, 4);
            
            const icoDir = Buffer.alloc(16);
            icoDir.writeUInt8(0, 0);
            icoDir.writeUInt8(0, 1);
            icoDir.writeUInt8(0, 2);
            icoDir.writeUInt8(0, 3);
            icoDir.writeUInt16LE(1, 4);
            icoDir.writeUInt16LE(32, 6);
            icoDir.writeUInt32LE(pngData.length, 8);
            icoDir.writeUInt32LE(22, 12);
            
            const ico = Buffer.concat([icoHeader, icoDir, pngData]);
            fs.writeFileSync(path.join(iconsDir, 'icon.ico'), ico);
            console.log('Created icon.ico');
            
            fs.writeFileSync(path.join(iconsDir, 'icon.icns'), ico256);
            console.log('Created icon.icns');
            
            console.log('All icons created');
          })();
          "

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'PerfectMD ${{ github.ref_name }}'
          releaseBody: |
            ## 下载安装
            - Windows: 下载 .msi 文件双击安装
            - macOS: 下载 .dmg 文件双击安装
            - Linux: 下载 .deb 或 .AppImage 文件
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            target: ''
          - platform: 'windows-latest'
            args: ''
            target: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: |
          npm install -g bun
          bun install

      - name: Generate icons (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p src-tauri/icons
          node << 'NODESCRIPT'
          const fs = require('fs');
          const path = require('path');
          const zlib = require('zlib');

          const iconsDir = path.join(process.cwd(), 'src-tauri', 'icons');
          if (!fs.existsSync(iconsDir)) fs.mkdirSync(iconsDir, { recursive: true });

          function createPNG(width, height, r, g, b, a) {
            const signature = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);
            const ihdrData = Buffer.alloc(13);
            ihdrData.writeUInt32BE(width, 0);
            ihdrData.writeUInt32BE(height, 4);
            ihdrData.writeUInt8(8, 8);
            ihdrData.writeUInt8(6, 9);
            ihdrData.writeUInt8(0, 10);
            ihdrData.writeUInt8(0, 11);
            ihdrData.writeUInt8(0, 12);
            const ihdr = createChunk('IHDR', ihdrData);
            const rawData = Buffer.alloc(height * (1 + width * 4));
            for (let y = 0; y < height; y++) {
              const rowStart = y * (1 + width * 4);
              rawData[rowStart] = 0;
              for (let x = 0; x < width; x++) {
                const pixelStart = rowStart + 1 + x * 4;
                rawData[pixelStart] = r;
                rawData[pixelStart + 1] = g;
                rawData[pixelStart + 2] = b;
                rawData[pixelStart + 3] = a;
              }
            }
            const compressed = zlib.deflateSync(rawData);
            const idat = createChunk('IDAT', compressed);
            const iend = createChunk('IEND', Buffer.alloc(0));
            return Buffer.concat([signature, ihdr, idat, iend]);
          }

          function createChunk(type, data) {
            const length = Buffer.alloc(4);
            length.writeUInt32BE(data.length, 0);
            const typeBuffer = Buffer.from(type);
            const crcData = Buffer.concat([typeBuffer, data]);
            const crc = crc32(crcData);
            const crcBuffer = Buffer.alloc(4);
            crcBuffer.writeUInt32BE(crc >>> 0, 0);
            return Buffer.concat([length, typeBuffer, data, crcBuffer]);
          }

          function crc32(data) {
            let crc = 0xFFFFFFFF;
            const table = [];
            for (let i = 0; i < 256; i++) {
              let c = i;
              for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
              table[i] = c;
            }
            for (let i = 0; i < data.length; i++) crc = table[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            return crc ^ 0xFFFFFFFF;
          }

          const color = { r: 102, g: 126, b: 234, a: 255 };
          const sizes = [[1024, 'icon.png'], [32, '32x32.png'], [128, '128x128.png'], [256, '128x128@2x.png']];
          for (const [size, name] of sizes) {
            const png = createPNG(size, size, color.r, color.g, color.b, color.a);
            fs.writeFileSync(path.join(iconsDir, name), png);
          }
          const png256 = createPNG(256, 256, color.r, color.g, color.b, color.a);
          const icoHeader = Buffer.from([0x00, 0x00, 0x01, 0x00, 0x01, 0x00]);
          const icoDir = Buffer.alloc(16);
          icoDir.writeUInt8(0, 0);
          icoDir.writeUInt8(0, 1);
          icoDir.writeUInt8(0, 2);
          icoDir.writeUInt8(0, 3);
          icoDir.writeUInt16LE(1, 4);
          icoDir.writeUInt16LE(32, 6);
          icoDir.writeUInt32LE(png256.length, 8);
          icoDir.writeUInt32LE(22, 12);
          fs.writeFileSync(path.join(iconsDir, 'icon.ico'), Buffer.concat([icoHeader, icoDir, png256]));
          fs.writeFileSync(path.join(iconsDir, 'icon.icns'), png256);
          console.log('Icons created');
          NODESCRIPT

      - name: Generate icons (Windows only)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "src-tauri\icons"
          
          # Download a valid ICO file from Tauri examples
          $icoUrl = "https://raw.githubusercontent.com/tauri-apps/tauri/dev/examples/api/src-tauri/icons/icon.ico"
          Invoke-WebRequest -Uri $icoUrl -OutFile "src-tauri\icons\icon.ico" -UseBasicParsing
          Write-Host "Downloaded icon.ico"
          
          # Create PNG files
          $pngUrl = "https://raw.githubusercontent.com/tauri-apps/tauri/dev/examples/api/src-tauri/icons/icon.png"
          Invoke-WebRequest -Uri $pngUrl -OutFile "src-tauri\icons\icon.png" -UseBasicParsing
          Invoke-WebRequest -Uri $pngUrl -OutFile "src-tauri\icons\32x32.png" -UseBasicParsing
          Invoke-WebRequest -Uri $pngUrl -OutFile "src-tauri\icons\128x128.png" -UseBasicParsing
          Invoke-WebRequest -Uri $pngUrl -OutFile "src-tauri\icons\128x128@2x.png" -UseBasicParsing
          Invoke-WebRequest -Uri $pngUrl -OutFile "src-tauri\icons\icon.icns" -UseBasicParsing
          Write-Host "Downloaded PNG files"
          
          Get-ChildItem "src-tauri\icons"

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'PerfectMD ${{ github.ref_name }}'
          releaseBody: |
            ## 下载安装
            - macOS M1/M2/M3: 下载 `_aarch64.dmg`
            - macOS Intel: 下载 `_x64.dmg`
            - Windows: 下载 `.msi`
            - Linux: 下载 `.deb` 或 `.AppImage`
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

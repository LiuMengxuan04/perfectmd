name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            target: ''
          - platform: 'windows-latest'
            args: ''
            target: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: |
          npm install -g bun
          bun install

      - name: Create icon generation script
        run: |
          mkdir -p src-tauri/icons

      - name: Generate icons
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const zlib = require('zlib');

          const iconsDir = path.join(process.cwd(), 'src-tauri', 'icons');
          console.log('Creating icons in:', iconsDir);

          if (!fs.existsSync(iconsDir)) {
            fs.mkdirSync(iconsDir, { recursive: true });
          }

          // BMP data for ICO (BGRA format)
          function createBmpData(w, h, r, g, b) {
            const data = Buffer.alloc(w * h * 4);
            for (let y = 0; y < h; y++) {
              for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                data[i] = b; data[i+1] = g; data[i+2] = r; data[i+3] = 0;
              }
            }
            return data;
          }

          function createAndMask(w, h) {
            return Buffer.alloc(Math.ceil(w / 8) * h);
          }

          function createIco() {
            const sizes = [{w:16,h:16},{w:32,h:32},{w:48,h:48},{w:256,h:256}];
            const r=102, g=126, b=234;
            let offset = 6 + 16 * sizes.length;
            const images = [];
            for (const s of sizes) {
              const bmp = createBmpData(s.w, s.h, r, g, b);
              const mask = createAndMask(s.w, s.h);
              const hdr = Buffer.alloc(40);
              hdr.writeUInt32LE(40, 0);
              hdr.writeInt32LE(s.w, 4);
              hdr.writeInt32LE(s.h * 2, 8);
              hdr.writeUInt16LE(1, 12);
              hdr.writeUInt16LE(32, 14);
              hdr.writeUInt32LE(bmp.length + mask.length, 20);
              const img = Buffer.concat([hdr, bmp, mask]);
              images.push({w: s.w, h: s.h, data: img, offset});
              offset += img.length;
            }
            const head = Buffer.alloc(6);
            head.writeUInt16LE(0, 0);
            head.writeUInt16LE(1, 2);
            head.writeUInt16LE(sizes.length, 4);
            const dirs = images.map(img => {
              const d = Buffer.alloc(16);
              d.writeUInt8(img.w >= 256 ? 0 : img.w, 0);
              d.writeUInt8(img.h >= 256 ? 0 : img.h, 1);
              d.writeUInt16LE(1, 4);
              d.writeUInt16LE(32, 6);
              d.writeUInt32LE(img.data.length, 8);
              d.writeUInt32LE(img.offset, 12);
              return d;
            });
            return Buffer.concat([head, ...dirs, ...images.map(i => i.data)]);
          }

          function createPNG(w, h, r, g, b, a) {
            const sig = Buffer.from([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]);
            const ihdr = Buffer.alloc(13);
            ihdr.writeUInt32BE(w, 0);
            ihdr.writeUInt32BE(h, 4);
            ihdr.writeUInt8(8, 8);
            ihdr.writeUInt8(6, 9);
            const raw = Buffer.alloc(h * (1 + w * 4));
            for (let y = 0; y < h; y++) {
              raw[y * (1 + w * 4)] = 0;
              for (let x = 0; x < w; x++) {
                const i = y * (1 + w * 4) + 1 + x * 4;
                raw[i] = r; raw[i+1] = g; raw[i+2] = b; raw[i+3] = a;
              }
            }
            const chunk = (t, d) => {
              const l = Buffer.alloc(4);
              l.writeUInt32BE(d.length, 0);
              const tb = Buffer.from(t);
              let c = 0xFFFFFFFF;
              const tbl = [];
              for (let i = 0; i < 256; i++) { let x = i; for (let j = 0; j < 8; j++) x = (x & 1) ? (0xEDB88320 ^ (x >>> 1)) : (x >>> 1); tbl[i] = x; }
              const cd = Buffer.concat([tb, d]);
              for (let i = 0; i < cd.length; i++) c = tbl[(c ^ cd[i]) & 0xFF] ^ (c >>> 8);
              const cr = Buffer.alloc(4);
              cr.writeUInt32BE((c ^ 0xFFFFFFFF) >>> 0, 0);
              return Buffer.concat([l, tb, d, cr]);
            };
            return Buffer.concat([sig, chunk('IHDR', ihdr), chunk('IDAT', zlib.deflateSync(raw)), chunk('IEND', Buffer.alloc(0))]);
          }

          // Create ICO
          const ico = createIco();
          fs.writeFileSync(path.join(iconsDir, 'icon.ico'), ico);
          console.log('Created icon.ico, size:', ico.length);

          // Create PNGs
          const c = {r:102,g:126,b:234,a:255};
          for (const [s, n] of [[1024,'icon.png'],[32,'32x32.png'],[128,'128x128.png'],[256,'128x128@2x.png']]) {
            fs.writeFileSync(path.join(iconsDir, n), createPNG(s, s, c.r, c.g, c.b, c.a));
          }
          fs.writeFileSync(path.join(iconsDir, 'icon.icns'), createPNG(256, 256, c.r, c.g, c.b, c.a));

          console.log('All icons created:', fs.readdirSync(iconsDir));
          "

      - name: Verify icons
        run: |
          echo "=== Icons directory ==="
          ls -la src-tauri/icons/ || dir src-tauri\\icons
          echo ""
          echo "=== Verifying ICO ==="
          cat src-tauri/icons/icon.ico | head -c 6 | xxd || type src-tauri\\icons\\icon.ico

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'PerfectMD ${{ github.ref_name }}'
          releaseBody: |
            ## 下载安装
            - macOS M1/M2/M3: 下载 `_aarch64.dmg`
            - macOS Intel: 下载 `_x64.dmg`
            - Windows: 下载 `.msi`
            - Linux: 下载 `.deb` 或 `.AppImage`
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
